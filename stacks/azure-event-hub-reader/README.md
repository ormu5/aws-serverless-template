# Overview

This Azure Event Hub reader is an implementation of [`EventHubConsumerClient`](https://learn.microsoft.com/en-us/javascript/api/@azure/event-hubs/eventhubconsumerclient?view=azure-node-latest)
and underlying classes that facilitate automatic checkpointing (Postgres, in this case) and load balancing. See `lib/ts/v1/eventHubIngest.ts`.

All partitions of remote event hub will be read from and checkpointed in configured database. Events are read from
the event hub and published to an SNS topic. A hydrated events receiver queue subscribes to that topic though
currently its Lambda only logs the events and does not persist them.

# Quick Start

1. SSM Params

   - `/<service>/<stage>/event-hub-connection-string`
   - `/<service>/<stage>/event-hub-name`
   - `/<service>/<stage>/event-hub-consumer-group`
   - `/<service>/<stage>/database-deployment-username`
   - `/<service>/<stage>/database-runtime-username`
   - `/<service>/<stage>/database-name`
2. `sls deploy --stage <stage> --app <app>`
3. `./db/scripts/init_aws_database.sh --service-name <> --resource-arn <> --master-secret-arn <> --stage <>`
4. Apply `./db/scripts/migrations` to database created in (3).

# Additional Configuration

- Update hydrated event handler/dlq to do more than just log.
- Update SNS message attribute mappings in lambda handlers (`EventPayload` and `parseMessageAttributesFromEvent`).
- `/lib/ts/v1/eventHubIngest.ts` has a bit of hard-coded config in it for underlying `EventHubConsumerClient`.
- Lambda currently configured to shut down 10s before timeout (which is currently set to 60s). This can be increased.

## MySQL

This Lambda was originally written to leverage MySQL. The bulk of the MySQL-specific application logic was
maintained in doc strings of respective functions, if anyone wishes to revive it. Database migrations will
have to be adjusted accordingly. MySQL config can be found commented in `docker-compose.yml`, as well, for 
local use. `init_local_database.sql` will also need to be tweaked.


# Local

# Deployed

# Non Functional

This Lambda was observed to cost $4-5 per month.

# Example

Example log output from Lambda working two Azure Event Hub partitions
```
1721101464294,"START RequestId: 4cb96405-c9e1-439f-92d5-54c2fb935976 Version: $LATEST"
1721101464296,"{""level"":""INFO"",""message"":""Successfully fetched values from SSM for params database-resource-arn,database-endpoint,database-runtime-secret-arn."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:24.296Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101464681,"{""level"":""INFO"",""message"":""Listing ownerships for example-ns.servicebus.windows.net, example-eh, $Default...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:24.681Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101465175,"{""level"":""INFO"",""message"":""2 partition ownership(s) returned: [{\""fullyQualifiedNamespace\"":\""example-ns.servicebus.windows.net\"",\""eventHubName\"":\""example-eh\"",\""consumerGroup\"":\""$Default\"",\""partitionId\"":\""1\"",\""lastModifiedTimeInMs\"":1721101454253,\""etag\"":\""fb75f5b4-ebaf-47d0-8fed-8696aad7d19b\""},{\""fullyQualifiedNamespace\"":\""example-ns.servicebus.windows.net\"",\""eventHubName\"":\""example-eh\"",\""consumerGroup\"":\""$Default\"",\""partitionId\"":\""0\"",\""lastModifiedTimeInMs\"":1721101454393,\""etag\"":\""7df730b5-6202-4002-84c6-5dca81e7fe5e\""}]"",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:25.175Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101465214,"{""level"":""INFO"",""message"":""Processing claim for partition ownership DbPartitionOwnership(database: aeh_reader, fullyQualifiedNamespace: example-ns.servicebus.windows.net, eventHubName: example-eh, consumerGroup: $Default, partitionId: 1, ownerId: 3d1b6383-8de6-405f-81a0-bb3345880a7b, etag: fb75f5b4-ebaf-47d0-8fed-8696aad7d19b)...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:25.213Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101465475,"{""level"":""INFO"",""message"":""3d1b6383-8de6-405f-81a0-bb3345880a7b claimed ownership of partition 1, last modified time of 1721101465213."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:25.475Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101465475,"{""level"":""INFO"",""message"":""Listing checkpoints for example-ns.servicebus.windows.net, example-eh, $Default...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:25.475Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101465681,"{""level"":""INFO"",""message"":""Returning 2 checkpoints."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:25.681Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101465875,"{""level"":""INFO"",""message"":""Processing events from partition 1...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:25.874Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101465875,"{""level"":""INFO"",""message"":""Publishing message on topic aeh-reader-hydrated-events-topic-v1-prod with {\""TopicArn\"":\""arn:aws:sns:us-east-1:123456789012:aeh-reader-hydrated-events-topic-v1-prod\"",\""Message\"":\""{\\\""body\\\"":{\\\""field_one\\\"":\\\""value1\\\"",\\\""field_two\\\"":\\\""value2\\\"",\\\""key3\\\"":\\\""value3\\\"",\\\""nestedKey\\\"":{\\\""nestedKey1\\\"":\\\""nestedValue1\\\""},\\\""arrayKey\\\"":[\\\""arrayValue1\\\"",\\\""arrayValue2\\\""]},\\\""offset\\\"":\\\""4294978336\\\"",\\\""sequenceNumber\\\"":121,\\\""enqueuedTimeUtc\\\"":\\\""2024-07-16T03:44:19.870Z\\\"",\\\""systemProperties\\\"":{\\\""x-opt-sequence-number-epoch\\\"":-1,\\\""contentType\\\"":\\\""application/json\\\""},\\\""contentType\\\"":\\\""application/json\\\""}\"",\""MessageAttributes\"":{\""fieldOne\"":{\""DataType\"":\""String\"",\""StringValue\"":\""value1\""},\""fieldTwo\"":{\""DataType\"":\""String\"",\""StringValue\"":\""value2\""}}}"",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:25.875Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101465876,"{""level"":""INFO"",""message"":""Publishing message on topic aeh-reader-hydrated-events-topic-v1-prod with {\""TopicArn\"":\""arn:aws:sns:us-east-1:123456789012:aeh-reader-hydrated-events-topic-v1-prod\"",\""Message\"":\""{\\\""body\\\"":{\\\""field_one\\\"":\\\""value1\\\"",\\\""field_two\\\"":\\\""value2\\\"",\\\""key3\\\"":\\\""value3\\\"",\\\""nestedKey\\\"":{\\\""nestedKey1\\\"":\\\""nestedValue1\\\""},\\\""arrayKey\\\"":[\\\""arrayValue1\\\"",\\\""arrayValue2\\\""]},\\\""offset\\\"":\\\""4294978704\\\"",\\\""sequenceNumber\\\"":122,\\\""enqueuedTimeUtc\\\"":\\\""2024-07-16T03:44:19.870Z\\\"",\\\""systemProperties\\\"":{\\\""x-opt-sequence-number-epoch\\\"":-1,\\\""contentType\\\"":\\\""application/json\\\""},\\\""contentType\\\"":\\\""application/json\\\""}\"",\""MessageAttributes\"":{\""fieldOne\"":{\""DataType\"":\""String\"",\""StringValue\"":\""value1\""},\""fieldTwo\"":{\""DataType\"":\""String\"",\""StringValue\"":\""value2\""}}}"",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:25.876Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101465876,"{""level"":""INFO"",""message"":""Publishing message on topic aeh-reader-hydrated-events-topic-v1-prod with {\""TopicArn\"":\""arn:aws:sns:us-east-1:123456789012:aeh-reader-hydrated-events-topic-v1-prod\"",\""Message\"":\""{\\\""body\\\"":{\\\""field_one\\\"":\\\""value1\\\"",\\\""field_two\\\"":\\\""value2\\\"",\\\""key3\\\"":\\\""value3\\\"",\\\""nestedKey\\\"":{\\\""nestedKey1\\\"":\\\""nestedValue1\\\""},\\\""arrayKey\\\"":[\\\""arrayValue1\\\"",\\\""arrayValue2\\\""]},\\\""offset\\\"":\\\""4294979072\\\"",\\\""sequenceNumber\\\"":123,\\\""enqueuedTimeUtc\\\"":\\\""2024-07-16T03:44:19.870Z\\\"",\\\""systemProperties\\\"":{\\\""x-opt-sequence-number-epoch\\\"":-1,\\\""contentType\\\"":\\\""application/json\\\""},\\\""contentType\\\"":\\\""application/json\\\""}\"",\""MessageAttributes\"":{\""fieldOne\"":{\""DataType\"":\""String\"",\""StringValue\"":\""value1\""},\""fieldTwo\"":{\""DataType\"":\""String\"",\""StringValue\"":\""value2\""}}}"",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:25.876Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
...
1721101466034,"{""level"":""INFO"",""message"":""Publishing message on topic aeh-reader-hydrated-events-topic-v1-prod with {\""TopicArn\"":\""arn:aws:sns:us-east-1:123456789012:aeh-reader-hydrated-events-topic-v1-prod\"",\""Message\"":\""{\\\""body\\\"":{\\\""field_one\\\"":\\\""value1\\\"",\\\""field_two\\\"":\\\""value2\\\"",\\\""key3\\\"":\\\""value3\\\"",\\\""nestedKey\\\"":{\\\""nestedKey1\\\"":\\\""nestedValue1\\\""},\\\""arrayKey\\\"":[\\\""arrayValue1\\\"",\\\""arrayValue2\\\""]},\\\""offset\\\"":\\\""4294985424\\\"",\\\""sequenceNumber\\\"":140,\\\""enqueuedTimeUtc\\\"":\\\""2024-07-16T03:44:24.370Z\\\"",\\\""systemProperties\\\"":{\\\""x-opt-sequence-number-epoch\\\"":-1,\\\""contentType\\\"":\\\""application/json\\\""},\\\""contentType\\\"":\\\""application/json\\\""}\"",\""MessageAttributes\"":{\""fieldOne\"":{\""DataType\"":\""String\"",\""StringValue\"":\""value1\""},\""fieldTwo\"":{\""DataType\"":\""String\"",\""StringValue\"":\""value2\""}}}"",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:26.034Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101468035,"{""level"":""INFO"",""message"":""Updating checkpoint to DbCheckpoint(database: aeh_reader, fullyQualifiedNamespace: example-ns.servicebus.windows.net, eventHubName: example-eh, consumerGroup: $Default, partitionId: 1, sequenceNumber: 140, offset: 4294985424, etag: 1b5ae3cf-1bba-4620-b576-18db24589fb4)...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:28.035Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101468074,"{""level"":""INFO"",""message"":""Updated checkpoint for partition 1 with sequence number 140."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:28.074Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101474302,"{""level"":""INFO"",""message"":""Listing ownerships for example-ns.servicebus.windows.net, example-eh, $Default...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:34.302Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101474355,"{""level"":""INFO"",""message"":""2 partition ownership(s) returned: [{\""fullyQualifiedNamespace\"":\""example-ns.servicebus.windows.net\"",\""eventHubName\"":\""example-eh\"",\""consumerGroup\"":\""$Default\"",\""partitionId\"":\""0\"",\""lastModifiedTimeInMs\"":1721101454393,\""etag\"":\""7df730b5-6202-4002-84c6-5dca81e7fe5e\""},{\""fullyQualifiedNamespace\"":\""example-ns.servicebus.windows.net\"",\""eventHubName\"":\""example-eh\"",\""consumerGroup\"":\""$Default\"",\""partitionId\"":\""1\"",\""ownerId\"":\""3d1b6383-8de6-405f-81a0-bb3345880a7b\"",\""lastModifiedTimeInMs\"":1721101465213,\""etag\"":\""390a0a4d-3018-45d0-ac4f-df3f9418e4e0\""}]"",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:34.354Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101474374,"{""level"":""INFO"",""message"":""Processing claim for partition ownership DbPartitionOwnership(database: aeh_reader, fullyQualifiedNamespace: example-ns.servicebus.windows.net, eventHubName: example-eh, consumerGroup: $Default, partitionId: 0, ownerId: 3d1b6383-8de6-405f-81a0-bb3345880a7b, etag: 7df730b5-6202-4002-84c6-5dca81e7fe5e)...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:34.374Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101474533,"{""level"":""INFO"",""message"":""3d1b6383-8de6-405f-81a0-bb3345880a7b claimed ownership of partition 0, last modified time of 1721101474374."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:34.515Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101474533,"{""level"":""INFO"",""message"":""Listing checkpoints for example-ns.servicebus.windows.net, example-eh, $Default...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:34.515Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101474694,"{""level"":""INFO"",""message"":""Returning 2 checkpoints."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:34.694Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101474695,"{""level"":""INFO"",""message"":""Processing claim for partition ownership DbPartitionOwnership(database: aeh_reader, fullyQualifiedNamespace: example-ns.servicebus.windows.net, eventHubName: example-eh, consumerGroup: $Default, partitionId: 1, ownerId: 3d1b6383-8de6-405f-81a0-bb3345880a7b, etag: 390a0a4d-3018-45d0-ac4f-df3f9418e4e0)...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:34.695Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101474875,"{""level"":""INFO"",""message"":""3d1b6383-8de6-405f-81a0-bb3345880a7b claimed ownership of partition 1, last modified time of 1721101474695."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:34.875Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101475074,"{""level"":""INFO"",""message"":""Processing events from partition 0...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:35.074Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101475074,"{""level"":""INFO"",""message"":""Publishing message on topic aeh-reader-hydrated-events-topic-v1-prod with {\""TopicArn\"":\""arn:aws:sns:us-east-1:123456789012:aeh-reader-hydrated-events-topic-v1-prod\"",\""Message\"":\""{\\\""body\\\"":{\\\""field_one\\\"":\\\""value1\\\"",\\\""field_two\\\"":\\\""value2\\\"",\\\""key3\\\"":\\\""value3\\\"",\\\""nestedKey\\\"":{\\\""nestedKey1\\\"":\\\""nestedValue1\\\""},\\\""arrayKey\\\"":[\\\""arrayValue1\\\"",\\\""arrayValue2\\\""]},\\\""offset\\\"":\\\""4294982032\\\"",\\\""sequenceNumber\\\"":130,\\\""enqueuedTimeUtc\\\"":\\\""2024-07-16T03:44:22.113Z\\\"",\\\""systemProperties\\\"":{\\\""x-opt-sequence-number-epoch\\\"":-1,\\\""contentType\\\"":\\\""application/json\\\""},\\\""contentType\\\"":\\\""application/json\\\""}\"",\""MessageAttributes\"":{\""fieldOne\"":{\""DataType\"":\""String\"",\""StringValue\"":\""value1\""},\""fieldTwo\"":{\""DataType\"":\""String\"",\""StringValue\"":\""value2\""}}}"",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:35.074Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101475075,"{""level"":""INFO"",""message"":""Publishing message on topic aeh-reader-hydrated-events-topic-v1-prod with {\""TopicArn\"":\""arn:aws:sns:us-east-1:123456789012:aeh-reader-hydrated-events-topic-v1-prod\"",\""Message\"":\""{\\\""body\\\"":{\\\""field_one\\\"":\\\""value1\\\"",\\\""field_two\\\"":\\\""value2\\\"",\\\""key3\\\"":\\\""value3\\\"",\\\""nestedKey\\\"":{\\\""nestedKey1\\\"":\\\""nestedValue1\\\""},\\\""arrayKey\\\"":[\\\""arrayValue1\\\"",\\\""arrayValue2\\\""]},\\\""offset\\\"":\\\""4294982408\\\"",\\\""sequenceNumber\\\"":131,\\\""enqueuedTimeUtc\\\"":\\\""2024-07-16T03:44:22.113Z\\\"",\\\""systemProperties\\\"":{\\\""x-opt-sequence-number-epoch\\\"":-1,\\\""contentType\\\"":\\\""application/json\\\""},\\\""contentType\\\"":\\\""application/json\\\""}\"",\""MessageAttributes\"":{\""fieldOne\"":{\""DataType\"":\""String\"",\""StringValue\"":\""value1\""},\""fieldTwo\"":{\""DataType\"":\""String\"",\""StringValue\"":\""value2\""}}}"",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:35.074Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
...
1721101475078,"{""level"":""INFO"",""message"":""Publishing message on topic aeh-reader-hydrated-events-topic-v1-prod with {\""TopicArn\"":\""arn:aws:sns:us-east-1:123456789012:aeh-reader-hydrated-events-topic-v1-prod\"",\""Message\"":\""{\\\""body\\\"":{\\\""field_one\\\"":\\\""value1\\\"",\\\""field_two\\\"":\\\""value2\\\"",\\\""key3\\\"":\\\""value3\\\"",\\\""nestedKey\\\"":{\\\""nestedKey1\\\"":\\\""nestedValue1\\\""},\\\""arrayKey\\\"":[\\\""arrayValue1\\\"",\\\""arrayValue2\\\""]},\\\""offset\\\"":\\\""4294985416\\\"",\\\""sequenceNumber\\\"":139,\\\""enqueuedTimeUtc\\\"":\\\""2024-07-16T03:44:22.113Z\\\"",\\\""systemProperties\\\"":{\\\""x-opt-sequence-number-epoch\\\"":-1,\\\""contentType\\\"":\\\""application/json\\\""},\\\""contentType\\\"":\\\""application/json\\\""}\"",\""MessageAttributes\"":{\""fieldOne\"":{\""DataType\"":\""String\"",\""StringValue\"":\""value1\""},\""fieldTwo\"":{\""DataType\"":\""String\"",\""StringValue\"":\""value2\""}}}"",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:35.078Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101476495,"{""level"":""INFO"",""message"":""Updating checkpoint to DbCheckpoint(database: aeh_reader, fullyQualifiedNamespace: example-ns.servicebus.windows.net, eventHubName: example-eh, consumerGroup: $Default, partitionId: 0, sequenceNumber: 139, offset: 4294985416, etag: 6677896c-b688-441a-b3d3-d3c13977c34e)...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:36.494Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101476694,"{""level"":""INFO"",""message"":""Updated checkpoint for partition 0 with sequence number 139."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:36.694Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101484302,"{""level"":""INFO"",""message"":""Listing ownerships for example-ns.servicebus.windows.net, example-eh, $Default...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:44.302Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101484355,"{""level"":""INFO"",""message"":""2 partition ownership(s) returned: [{\""fullyQualifiedNamespace\"":\""example-ns.servicebus.windows.net\"",\""eventHubName\"":\""example-eh\"",\""consumerGroup\"":\""$Default\"",\""partitionId\"":\""0\"",\""ownerId\"":\""3d1b6383-8de6-405f-81a0-bb3345880a7b\"",\""lastModifiedTimeInMs\"":1721101474374,\""etag\"":\""fb036140-0e57-4906-bb3f-95de0c79a271\""},{\""fullyQualifiedNamespace\"":\""example-ns.servicebus.windows.net\"",\""eventHubName\"":\""example-eh\"",\""consumerGroup\"":\""$Default\"",\""partitionId\"":\""1\"",\""ownerId\"":\""3d1b6383-8de6-405f-81a0-bb3345880a7b\"",\""lastModifiedTimeInMs\"":1721101474695,\""etag\"":\""4fbb1a5a-54cf-47fe-9638-e7527e214eac\""}]"",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:44.355Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101484374,"{""level"":""INFO"",""message"":""Processing claim for partition ownership DbPartitionOwnership(database: aeh_reader, fullyQualifiedNamespace: example-ns.servicebus.windows.net, eventHubName: example-eh, consumerGroup: $Default, partitionId: 0, ownerId: 3d1b6383-8de6-405f-81a0-bb3345880a7b, etag: fb036140-0e57-4906-bb3f-95de0c79a271)...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:44.374Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101484495,"{""level"":""INFO"",""message"":""3d1b6383-8de6-405f-81a0-bb3345880a7b claimed ownership of partition 0, last modified time of 1721101484374."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:44.494Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101484495,"{""level"":""INFO"",""message"":""Processing claim for partition ownership DbPartitionOwnership(database: aeh_reader, fullyQualifiedNamespace: example-ns.servicebus.windows.net, eventHubName: example-eh, consumerGroup: $Default, partitionId: 1, ownerId: 3d1b6383-8de6-405f-81a0-bb3345880a7b, etag: 4fbb1a5a-54cf-47fe-9638-e7527e214eac)...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:44.495Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101484695,"{""level"":""INFO"",""message"":""3d1b6383-8de6-405f-81a0-bb3345880a7b claimed ownership of partition 1, last modified time of 1721101484495."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:44.695Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101494301,"{""level"":""INFO"",""message"":""Listing ownerships for example-ns.servicebus.windows.net, example-eh, $Default...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:54.301Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101494354,"{""level"":""INFO"",""message"":""2 partition ownership(s) returned: [{\""fullyQualifiedNamespace\"":\""example-ns.servicebus.windows.net\"",\""eventHubName\"":\""example-eh\"",\""consumerGroup\"":\""$Default\"",\""partitionId\"":\""0\"",\""ownerId\"":\""3d1b6383-8de6-405f-81a0-bb3345880a7b\"",\""lastModifiedTimeInMs\"":1721101484374,\""etag\"":\""edf4ce83-d897-4996-8a49-aa3d15bfb8ce\""},{\""fullyQualifiedNamespace\"":\""example-ns.servicebus.windows.net\"",\""eventHubName\"":\""example-eh\"",\""consumerGroup\"":\""$Default\"",\""partitionId\"":\""1\"",\""ownerId\"":\""3d1b6383-8de6-405f-81a0-bb3345880a7b\"",\""lastModifiedTimeInMs\"":1721101484495,\""etag\"":\""2cdef79d-6a0c-40e3-899f-733ff426d361\""}]"",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:54.354Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101494355,"{""level"":""INFO"",""message"":""Processing claim for partition ownership DbPartitionOwnership(database: aeh_reader, fullyQualifiedNamespace: example-ns.servicebus.windows.net, eventHubName: example-eh, consumerGroup: $Default, partitionId: 0, ownerId: 3d1b6383-8de6-405f-81a0-bb3345880a7b, etag: edf4ce83-d897-4996-8a49-aa3d15bfb8ce)...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:54.354Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101494475,"{""level"":""INFO"",""message"":""3d1b6383-8de6-405f-81a0-bb3345880a7b claimed ownership of partition 0, last modified time of 1721101494354."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:54.474Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101494475,"{""level"":""INFO"",""message"":""Processing claim for partition ownership DbPartitionOwnership(database: aeh_reader, fullyQualifiedNamespace: example-ns.servicebus.windows.net, eventHubName: example-eh, consumerGroup: $Default, partitionId: 1, ownerId: 3d1b6383-8de6-405f-81a0-bb3345880a7b, etag: 2cdef79d-6a0c-40e3-899f-733ff426d361)...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:54.475Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101494715,"{""level"":""INFO"",""message"":""3d1b6383-8de6-405f-81a0-bb3345880a7b claimed ownership of partition 1, last modified time of 1721101494475."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:44:54.714Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101504301,"{""level"":""INFO"",""message"":""Listing ownerships for example-ns.servicebus.windows.net, example-eh, $Default...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:45:04.300Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101504334,"{""level"":""INFO"",""message"":""2 partition ownership(s) returned: [{\""fullyQualifiedNamespace\"":\""example-ns.servicebus.windows.net\"",\""eventHubName\"":\""example-eh\"",\""consumerGroup\"":\""$Default\"",\""partitionId\"":\""0\"",\""ownerId\"":\""3d1b6383-8de6-405f-81a0-bb3345880a7b\"",\""lastModifiedTimeInMs\"":1721101494354,\""etag\"":\""4a39d0fa-b70a-41ce-820d-ee1478939559\""},{\""fullyQualifiedNamespace\"":\""example-ns.servicebus.windows.net\"",\""eventHubName\"":\""example-eh\"",\""consumerGroup\"":\""$Default\"",\""partitionId\"":\""1\"",\""ownerId\"":\""3d1b6383-8de6-405f-81a0-bb3345880a7b\"",\""lastModifiedTimeInMs\"":1721101494475,\""etag\"":\""4e517036-9521-4312-a574-fa28a7e80241\""}]"",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:45:04.334Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101504335,"{""level"":""INFO"",""message"":""Processing claim for partition ownership DbPartitionOwnership(database: aeh_reader, fullyQualifiedNamespace: example-ns.servicebus.windows.net, eventHubName: example-eh, consumerGroup: $Default, partitionId: 0, ownerId: 3d1b6383-8de6-405f-81a0-bb3345880a7b, etag: 4a39d0fa-b70a-41ce-820d-ee1478939559)...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:45:04.334Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101504475,"{""level"":""INFO"",""message"":""3d1b6383-8de6-405f-81a0-bb3345880a7b claimed ownership of partition 0, last modified time of 1721101504334."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:45:04.474Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101504475,"{""level"":""INFO"",""message"":""Processing claim for partition ownership DbPartitionOwnership(database: aeh_reader, fullyQualifiedNamespace: example-ns.servicebus.windows.net, eventHubName: example-eh, consumerGroup: $Default, partitionId: 1, ownerId: 3d1b6383-8de6-405f-81a0-bb3345880a7b, etag: 4e517036-9521-4312-a574-fa28a7e80241)...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:45:04.475Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101504615,"{""level"":""INFO"",""message"":""3d1b6383-8de6-405f-81a0-bb3345880a7b claimed ownership of partition 1, last modified time of 1721101504475."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:45:04.615Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101514315,"{""level"":""INFO"",""message"":""Listing ownerships for example-ns.servicebus.windows.net, example-eh, $Default...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:45:14.315Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101514385,"{""level"":""INFO"",""message"":""2 partition ownership(s) returned: [{\""fullyQualifiedNamespace\"":\""example-ns.servicebus.windows.net\"",\""eventHubName\"":\""example-eh\"",\""consumerGroup\"":\""$Default\"",\""partitionId\"":\""0\"",\""ownerId\"":\""3d1b6383-8de6-405f-81a0-bb3345880a7b\"",\""lastModifiedTimeInMs\"":1721101504334,\""etag\"":\""dd70ad02-3a7d-42a0-a30b-98c98b143c90\""},{\""fullyQualifiedNamespace\"":\""example-ns.servicebus.windows.net\"",\""eventHubName\"":\""example-eh\"",\""consumerGroup\"":\""$Default\"",\""partitionId\"":\""1\"",\""ownerId\"":\""3d1b6383-8de6-405f-81a0-bb3345880a7b\"",\""lastModifiedTimeInMs\"":1721101504475,\""etag\"":\""c42ebd10-b4b7-45ac-a45c-abf5047d3820\""}]"",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:45:14.385Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101514385,"{""level"":""INFO"",""message"":""Processing claim for partition ownership DbPartitionOwnership(database: aeh_reader, fullyQualifiedNamespace: example-ns.servicebus.windows.net, eventHubName: example-eh, consumerGroup: $Default, partitionId: 0, ownerId: , etag: dd70ad02-3a7d-42a0-a30b-98c98b143c90)...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:45:14.385Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101514615,"{""level"":""INFO"",""message"":""Partition 0 gracefully released from ownership with last modified time of 1721101514385."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:45:14.614Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101514615,"{""level"":""INFO"",""message"":""Processing claim for partition ownership DbPartitionOwnership(database: aeh_reader, fullyQualifiedNamespace: example-ns.servicebus.windows.net, eventHubName: example-eh, consumerGroup: $Default, partitionId: 1, ownerId: , etag: c42ebd10-b4b7-45ac-a45c-abf5047d3820)...."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:45:14.615Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101514815,"{""level"":""INFO"",""message"":""Partition 1 gracefully released from ownership with last modified time of 1721101514615."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:45:14.815Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101514954,"{""level"":""INFO"",""message"":""Done with this Lambda execution, shutting down after collecting 30 events."",""sampling_rate"":0,""service"":""aeh-reader"",""timestamp"":""2024-07-16T03:45:14.954Z"",""xray_trace_id"":""1-6695ec98-799bb137300ea2f318d2fceb"",""aws_account_id"":""123456789012"",""aws_region"":""us-east-1""}"
1721101514974,"END RequestId: 4cb96405-c9e1-439f-92d5-54c2fb935976"
1721101514974,"REPORT RequestId: 4cb96405-c9e1-439f-92d5-54c2fb935976	Duration: 50679.66 ms	Billed Duration: 50680 ms	Memory Size: 128 MB	Max Memory Used: 106 MB"
```

# TODO

- Event hub manager Lambda for workers; gist:
  - A warning is currently generated/logged when message age exceeds a certain point.
    This same warning could serve as a basis to send event to manager Lambda that then checks
    to see how many Lambda instances are running (probably best based on checkpoint table). If
    anything less than one Lambda per remote partition is running, the manager could spin up
    another worker. If a single instance of a Lambda can keep up with all partitions, no warning is
    is generated and the manager need not spin up more instances.
- Intelligent spin-down of workers (efficiency) during sparse event hub messages.